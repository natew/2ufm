<!doctype html>
<html lang="en">
<head>
  <!-- Meta -->
  <meta charset="utf-8">
  <%= csrf_meta_tag %>
  <meta name="author" content="Nate Wienert">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

  <%- if params[:listen]
        @listen_song = Song.find(params[:listen_song_id]) -%>
    <!-- OpenGraph -->
    <meta property="og:title" content="<%= @listen_song.full_name %>" />
    <meta property="og:description" content="Listen now on 2u.fm" />
    <meta property="og:image" content="<%= @listen_song.resolve_image %>" />
  <%- end -%>

  <title><%= title %></title>

  <!-- HTML5 shim, for IE6-8 support of HTML elements -->
  <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <%= stylesheet_link_tag "application", :debug => Rails.env.development? %>
  <link href='http://fonts.googleapis.com/css?family=Open+Sans:300,400' rel='stylesheet' type='text/css'>

  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-32843361-1']);
    _gaq.push(['_trackPageview']);
    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>

  <script type="text/javascript">
    var updateBroadcastsIds, updateFollowsIds, updateListensIds, updateBroadcastsCounts,
        broadcastedIds = [];

    <%- if user_signed_in? -%>
      beginListen = <%= raw current_user.listens.last.as_json.to_json %>;
    <%- else -%>
      beginListen = false;
    <%- end -%>
  </script>
</head>

<body class="<%= body_classes %>" data-soundcloud-key="<%= Yetting.soundcloud_key %>" data-media="<%= Yetting.s3_url %>"<% if user_signed_in? %> data-user="<%= current_user.id %>" <% if current_user.can_download? %> data-role="admin"<% end %><% end %>>

  <div id="body-wrap">
    <header>
      <h1><%= link_to '2u.fm', '/', title: '2u.fm, find and share music', class: 'nav-hover', 'data-target' => '#logo-menu', 'data-pad' => '-2', 'data-delay' => '300' %></h1>

      <div id="bar">
        <div id="player">
          <div id="player-controls" class="player-buttons">
            <%= link_to '<span>4</span>'.html_safe, '#', :class => 'play pictos control', :id => 'player-play', :title => 'Play/pause' %>
            <%= link_to '<span>7</span>'.html_safe, '#', :class => 'next pictos control', :id => 'player-next', :title => 'Next song' %>
          </div>

          <div id="player-buttons">
            <span class="broadcast">
              <%= render partial: "songs/broadcast", locals: { action: 'add', id: '0', count: 'Like', extra_class: 'disabled'  } %>
              <%= render partial: "songs/broadcast", locals: { action: 'destroy', id: '0', count: 'Unlike'  } %>
            </span>
            <%= link_to 'Share', '#share', :id => 'player-share', :class => 'nav-hover control pictos-link disabled update-clipboard', 'data-pad' => '5'  %>
            <%= link_to 'Playlist', '#player-playlist', :class => 'nav-hover control pictos-list disabled', :id => 'nav-music', 'data-pad' => '5' %>
            <%= link_to 'Off', '#friends', id: 'tune-in', class: 'nav-hover hover-off control pictos-globe tip-e', 'data-pad' => '18', title: 'Turn on live listening' %>
          </div>

          <div id="player-main">

            <div id="player-meta">
              <span id="player-song-name"><a title="Return to song" class="tip-n" href="">&nbsp;</a></span>
              <span id="player-artist-name">&nbsp;</span>
            </div>

            <div id="player-bottom">
              <div id="player-mini-controls">
                <%= link_to 'Sound', '#', :class => 'volume control pictos-volume-on tip', :id => 'player-volume', title: 'Volume' %>
                <%= link_to 'Normal', "", :id => 'player-mode', :class => 'control pictos-normal post tip', title: 'Play in order' %>
              </div>
              <div id="player-progress-bar">
                <div id="player-progress-grabber"></div>
                <div id="player-progress-inner-wrap">
                  <div id="player-progress-position"></div>
                  <div id="player-progress-loaded"></div>
                </div>
              </div>
              <div id="player-timer">0:00</div>
            </div>
            <!-- /player bottom -->
          </div>
          <!-- /player-meta -->
        </div>
        <!-- /player-main -->
      </div>
      <!-- /player -->
    </header>

    <div id="player-live">
      <%= link_to '0 people listening to you', '', 'data-count' => '0' %>
    </div>

    <div id="main-mid">
      <%= form_tag '/us/search', :method => 'get', :id => "search-form" do %>
        <%= text_field_tag :query, '' %>
        <%= submit_tag :s, :id => 'search', :class => 'pictos tip-n', :title => 'Search!' %>
      <% end -%>

      <div id="navbar">
        <div id="navbar-menus">
          <div id="navbar-menus-inner">

            <%- if user_signed_in? -%>
            <section class="nav-user">
              <h1>
                <%= current_user.username %>
                <div>
                  <%= link_to 'Log out', destroy_user_session_path, :method => 'delete', class: 'pictos-delete secondary tip', title: 'Log out' %>
                  <%= link_to "Account", user_account_path, class: 'pictos-gear tip', title: 'Account &amp; Settings'.html_safe  %>
                </div>
              </h1>
              <%= link_to ("Profile " + image_tag(current_user.avatar.url(:small))).html_safe, '/' + current_user.station_slug, :id => 'nav-user' %>
              <%= link_to 'Feed', feed_user_path(current_user), :id => 'nav-feed', :class => 'pictos-list' %>
              <%= link_to 'Inbox', '/shares/inbox', :id => 'nav-shares', :class => 'pictos-inbox', 'data-shares' => current_user.received_songs_notifications %>
            </section>
            <%- end -%>

            <section>
              <h1>Browse</h1>
              <%= link_to 'Trending', '/', :id => 'nav-trending', :class => 'pictos-pulse'  %>
              <%= link_to 'Latest', songs_fresh_path, :id => 'nav-new', :class => 'pictos-time' %>
              <%= link_to 'Genres', '#navbar-genres', :id => 'nav-genres', :class => 'pictos-music control', 'data-toggle' => 'invisible' %>

              <div id="navbar-genres" class="invisible scroll-section">
                <div id="navbar-genres-wrap">
                  <%= render 'genres/links' %>
                </div>
              </div>

              <%= link_to 'Artists', artists_path, :id => 'nav-artists', :class => 'pictos-users' %>
              <%= link_to 'Blogs', browse_path, :id => 'nav-artists', :class => 'pictos-newspaper' %>
            </section>

            <% unless user_signed_in? %>
            <section class="nav-extra account">
              <%= link_to 'Log in', '#modal-login', :class => 'modal control' %>
            </section>
            <% end %>
          </div>
        </div>

        <section id="navbar-friends">
          <h1>Friends</h1>
          <div class="scroll-section">
            <div id="navbar-friends-inner"></div>
          </div>
        </section>
      </div>

      <div id="body">
        <%= render :template => 'layouts/single' %>
      </div>

      <% ad_spot('leaderboard', controller) do |ad| %>
        <div id="promo-fixed-lower">
          <%= ad %>
        </div>
      <% end %>
    </div>
  </div>

  <% if !user_signed_in? %>
  <div id="welcome">
    <h3>What is 2u.fm?</h3>
    <section>
      <h1>Up to the minute songs from music blogs around the web.</h1>
      <h1>The easiest way to share and listen to music with your friends.</h1>
      <h1>Follow artists you love and and fill your feed with their newest music.</h1>
    </section>
    <% link_to 'Learn More', '/go/tour', :class => 'button add' %>
    <%= link_to 'D', '', :class => 'control pictos', :id => 'close-welcome' %>
  </div>
  <% end %>

  <!-- Hover menus -->

  <div id="player-playlist" class="pop-menu right-align"></div>
  <div id="player-playlist-template" class="hidden">
    <h4>{{station.title}}</h4>
    {{#songs}}
      <a class="control song-{{id}}" href="#song-{{id}}" data-index="{{index}}">
        <span class="artist">{{artist_name}}</span> - <span class="name">{{name}}</span>
      </a>
    {{/songs}}
  </div>

  <div id="share" class="pop-menu">
    <%= link_to image_tag('/images/facebook.png'), '', :class => 'player-invite control popup', 'data-dimensions' => '800,400', 'data-link' => 'http://facebook.com/sharer.php?u={{url}}&t={{text}}' %>
    <%= link_to image_tag('/images/twitter.png'), '', :class => 'player-invite control popup', 'data-dimensions' => '600,300', 'data-link' => 'https://twitter.com/share?url={{url}}&text={{text}}' %>
    <span id="share-link-container"><%= link_to "j", '', :id => 'share-link', :class => 'control pictos tip', :title => "Copy link to clipboard", 'data-click' => '3' %></span>
    <div id="share-friends"></div>
  </div>

  <div id="logo-menu" class="pop-menu left-align">
    <div id="head-colors" class="colors">
    <% (1..5).each do |color| %>
      <%= link_to '', "theme-head-#{color}", class: "head-color-#{color}" %>
    <% end %>
    </div>
    <div id="body-colors" class="colors">
    <% (1..5).each do |color| %>
      <%= link_to '', "theme-body-#{color}", class: "body-color-#{color}" %>
    <% end %>
    </div>

    <%= link_to 'About Us', about_main_path %>
    <%= link_to 'Legal', legal_main_path %>
    <%= link_to 'Privacy Policy', privacy_main_path %>
    <%= link_to 'Contact', contact_main_path %>
  </div>

  <div id="friends" class="pop-menu right-align"></div>


  <!-- Modals -->

  <div id="overlay" class="shown slow-fade"></div>
  <div id="modal"></div>

  <div class="hidden">
    <% if !user_signed_in? %>
      <%= render 'modals/login' %>
    <% else %>

      <% if current_user.facebook_id.nil? %>

        <div id="modal-new-user">
          <h3>Please re-sync with Facebook</h3>
          <p>To allow friends to find you, please sync with Facebook again!  Sry bout that yo.</p>
          <div class="inline">
            <%= link_to "Link with Facebook", user_omniauth_authorize_path(:facebook), :class => 'facebook-button login-button popup button control', 'data-dimensions' => '800,500' %>
          </div>
        </div>

      <% elsif current_user.full_name.nil? or current_user.full_name == '' %>

        <div id="modal-new-user">
          <h3>Please enter your name</h3>
          <div class="inline">
            <%= form_tag user_account_path do %>
              <div class="clearfix">
                <%= label :user, :full_name, 'Full Name', :class => 'inline' %>
                <%= text_field_tag 'user[full_name]' %>
              </div>

              <div class="actions">
                <%= submit_tag 'Update', :class => 'right' %>
              </div>
            <% end %>
          </div>
        </div>

      <% elsif current_user.first_time? %>
        <%= render 'modals/new_user' %>
      <% end %>
    <% end %>

    <div id="friends-template">
      <div class="online">
      {{#online}}
        <%= render partial: 'users/friend_link' %>
      {{/online}}
      </div>
      {{#offline}}
        <%= render partial: 'users/friend_link' %>
      {{/offline}}
      <%= link_to "Find friends", users_friends_path, id: 'nav-friends', class:'friend-link' %>
    </div>
  </div>

  <!-- Others -->
  <div id="song-dragger" class="pictos">m</div>
  <div id="spinner" class="hidden"></div>
  <div id="null"></div>
  <div id="tunein"></div>

    <script type="text/javascript">
      <%- if params[:listen] -%>
        var listen = <%= raw params[:listen] %>,
            route = "<%= params[:route] %>";
      <%- else -%>
        var listen, route;
      <%- end -%>
    </script>

  <%= javascript_include_tag "application", :debug => Rails.env.development? %>
  <%= subscribe_to "/users/#{current_user.id}" if user_signed_in? %>
</body>
</html>