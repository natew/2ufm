<%- if song.respond_to?('sender_username') -%>
  <h4 class="song-sender">Sent from <%= link_to song.sender_username, song.sender_station_slug %> <small><%= relative_time(song.sent_at) %></small></h4>
<%- elsif song.respond_to?('receiver_username') -%>
  <h4 class="song-sender">Sent to <%= link_to song.receiver_username, song.receiver_station_slug %> <small><%= relative_time(song.sent_at) %></small></h4>
<%- end -%>

<%-
  id = song.matching_id.to_s
  station_id ||= -1
-%>
<section id="song-<%= song.matching_id %>" data-index="<%= song_counter %>" data-station="<%= station_id %>-<%= page %>" data-slug="<%= song.slug %>">

<%-
  cache ['v1', song] do
    follow_id    = 'station-follow-' + id
    cover      ||= :icon
    broadcasted  = song.respond_to? :broadcasted_at
    with_follow  = song.respond_to? :following_station_id
    show_original = (!with_follow or song.following_station_id != song.station_id)
-%>

  <div class="song-info">
    <%= image_tag song.resolve_image(cover), :class => "song-art cover-#{cover}" %>

    <h1>
      <%-
        links = author_links(song.authors)
        if links[:original].length > 0
      -%>
      <span class="artist"><%= links[:original] %></span>
      <% end %>
      <span class="name"><%= tagged_song_name(song.name) %> <em><%= links[:other] %></em></span>
    </h1>
  </div>

  <div class="song-meta">
    <div class="song-meta-pre">
      <%= render :partial => 'songs/posted', :locals => { :song => song } if show_original  %>
      <%= render :partial => 'songs/posted', :locals => { :song => song, :broadcasted => true } if with_follow %>
    </div>

    <div class="song-controls">
      <span class="broadcast"><%= broadcast_song(song) %></span>
      <%= link_to '0', '', :class => 'pictos-comment control restricted' %>
      <%= link_to 'Share', '#share', :class => 'nav-hover song-share restricted control', 'data-pad' => '20', 'data-id' => id %>
    </div>
  </div>

  <%= image_tag song.waveform, :class => 'waveform' if song.waveform? %>

  <div class="reviews">
    <%= render :partial => 'blogs/review', :collection => [song] %>
  </div>

  <%= link_to '', "#song-#{song.matching_id}", :class => 'song-link play-song control' %>
</section>

<%-
  end # end cache

  page = (song_counter + 1) / Yetting.per
-%>

<%= link_to "Page #{((song_counter+1)/Yetting.per) + 1}", '', :class => 'next-page control loaded' if (song_counter + 1) % Yetting.per == 0 and page < params[:p].to_i  %>